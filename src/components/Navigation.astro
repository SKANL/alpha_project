---
import { Image } from "astro:assets";
interface Props {
  currentPage?: string;
}

import { supabase } from "../lib/supabase";

const { currentPage = "" } = Astro.props;

// Try to load profile server-side so the sidebar can display firm name/logo globally
const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

let profile: any = null;
if (accessToken && refreshToken) {
  try {
    const { data } = await supabase.auth.setSession({
      access_token: accessToken.value,
      refresh_token: refreshToken.value,
    });
    const user = data?.user;
    if (user) {
      const { data: p } = await supabase
        .from("profiles")
        .select("*")
        .eq("user_id", user.id)
        .maybeSingle();
      profile = p;
    }
  } catch (e) {
    // ignore - fallback to defaults
    profile = null;
  }
}

const navItems = [
  { href: "/dashboard", label: "Panel", id: "dashboard" },
  { href: "/dashboard/profile", label: "Despacho", id: "profile" },
  { href: "/dashboard/clients", label: "Clientes", id: "clients" },
  {
    href: "/dashboard/templates/contracts",
    label: "Contratos",
    id: "contracts",
  },
  {
    href: "/dashboard/templates/questionnaires",
    label: "Cuestionarios",
    id: "questionnaires",
  },
  {
    href: "/dashboard/membresias",
    label: "Membres√≠as",
    id: "membresias",
  },
];
---

<nav
  class="fixed left-0 top-0 h-screen w-60 flex flex-col bg-surface-card border-r border-border overflow-hidden"
>
  <!-- Header -->
  <div class="p-8 border-b border-border-weak">
    {
      profile?.firm_logo_url ? (
        <div class="mb-4 bg-white rounded p-2 inline-block">
          <Image
            src={profile.firm_logo_url}
            alt={profile.firm_name || "Logo"}
            width={32}
            height={32}
            class="w-8 h-8 object-contain"
          />
        </div>
      ) : (
        <div class="w-8 h-8 bg-gradient-to-br from-white to-neutral-500 rounded mb-4" />
      )
    }

    <h1
      class="text-sm font-light tracking-widest uppercase text-content-primary"
    >
      {profile?.firm_name || "LEGAL STUDIO"}
    </h1>
  </div>

  <!-- Links -->
  <div class="flex-1 py-12 flex flex-col gap-2">
    {
      navItems.map((item) => (
        <a
          href={item.href}
          class:list={[
            "relative block px-8 py-4 text-sm font-light tracking-wider transition-all duration-300 hover:text-content-primary",
            currentPage === item.id
              ? "text-content-primary"
              : "text-content-secondary",
          ]}
        >
          <span
            class:list={[
              "absolute left-0 top-1/2 -translate-y-1/2 w-0.5 bg-content-primary transition-all duration-300",
              currentPage === item.id ? "h-8" : "h-0 group-hover:h-6",
            ]}
          />
          {item.label}
        </a>
      ))
    }
  </div>

  <!-- Footer -->
  <form
    action="/api/auth/signout"
    method="post"
    class="p-8 border-t border-border-weak"
  >
    <button
      type="submit"
      class="text-sm font-light tracking-wider text-content-muted hover:text-status-error transition-colors duration-300"
    >
      Salir
    </button>
  </form>
</nav>

---
import Layout from "../../layouts/Layout.astro";

const { token } = Astro.params;

if (!token) {
  return Astro.redirect("/");
}
---

<Layout title="Bienvenida">
  <div id="app" class="welcome-container">
    <!-- Loading Screen -->
    <div id="loading" class="loading-screen">
      <div class="loader"></div>
      <p class="loading-text">Cargando...</p>
    </div>

    <!-- Step 1: Welcome -->
    <div id="step1" class="step" style="display: none;">
      <div class="step-wrapper">
        <div id="firmLogo" class="firm-logo"></div>
        
        <div class="form-header">
          <h1 id="firmName">ようこそ</h1>
          <p id="clientName" class="client-name"></p>
          <p>welcome</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <p class="welcome-text">
            Te guiaremos paso a paso para completar tu proceso de incorporación. Solo tomará unos minutos.
          </p>
          
          <button class="btn-primary" onclick="nextStep(2)">
            Comenzar
          </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Contract -->
    <div id="step2" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>契約</h1>
          <p>contrato</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
            <div class="contract-viewer">
              <div class="contract-actions">
                <p class="contract-help">abre el documento en una nueva pestaña.</p>
                <a id="openDocumentBtn" class="btn-primary" target="_blank" rel="noopener noreferrer" href="#">Abrir documento en nueva pestaña</a>
              </div>
            </div>

          <div class="signature-section">
            <label for="signatureCanvas">Tu Firma Digital</label>
            <canvas id="signatureCanvas"></canvas>
            <button type="button" class="btn-secondary" onclick="clearSignature()">
              Limpiar
            </button>
          </div>

          <button class="btn-primary" onclick="signContract()" disabled id="signBtn">
            Aceptar y Firmar
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Documents -->
    <div id="step3" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>書類</h1>
          <p>documentos</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <div id="documentsContainer" class="documents-container"></div>

          <button class="btn-primary" onclick="nextStep(4)">
            Continuar
          </button>
        </div>
      </div>
    </div>

    <!-- Step 4: Questionnaire -->
    <div id="step4" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>質問</h1>
          <p>cuestionario</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <form id="questionnaireForm" class="questionnaire-form"></form>

          <button class="btn-primary" onclick="submitQuestionnaire()">
            Enviar Respuestas
          </button>
        </div>
      </div>
    </div>

    <!-- Step 5: Complete -->
    <div id="step5" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>完璧</h1>
          <p>perfecto</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <div class="success-message">
            <div class="success-icon">✓</div>
            <p class="success-text">
              Tu información ha sido recibida exitosamente. Pronto nos pondremos en contacto contigo.
            </p>
          </div>

          <div id="calendarSection" class="calendar-section" style="display: none;">
            <div class="form-divider"></div>
            <p class="calendar-text">Agenda tu primera reunión</p>
            <a id="calendarLink" href="#" target="_blank" class="btn-primary">
              Agendar Reunión
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen" class="error-screen" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>エラー</h1>
          <p>error</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <p id="errorMessage" class="error-text">
            Este link no es válido o ya fue utilizado.
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* Container Principal */
  .welcome-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    background: var(--bg-dark-main);
  }

  /* Loading Screen */
  .loading-screen,
  .error-screen {
    text-align: center;
    animation: fadeInUp 0.6s ease-out;
  }

  .loader {
    border: 2px solid var(--border-dark);
    border-top: 2px solid var(--accent-light);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }

  .loading-text {
    font-size: 0.875rem;
    font-weight: 300;
    color: var(--text-dark-secondary);
    letter-spacing: 0.05em;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Steps */
  .step {
    width: 100%;
    max-width: 1200px;
    animation: fadeInUp 0.6s ease-out;
    display: flex;
    justify-content: center;
  }

  .step-wrapper {
    width: 100%;
    /* Allow wider content for contract view while keeping a comfortable reading column */
    max-width: 920px;
  }

  /* Firm Logo */
  .firm-logo {
    text-align: center;
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .firm-logo img {
    /* Reduced 60% from previous 50x25 -> now ~20x10 */
      max-width: 20px;
      max-height: 10px;
      width: 20px !important;
      height: 10px !important;
      object-fit: contain;
      opacity: 0.9;
      display: block;
      margin: 0 auto;
  }

    /* extra selector to ensure third-party styles or inline images don't render at full size */
    .firm-logo-img {
      width: 20px !important;
      height: 10px !important;
      max-width: 20px !important;
      max-height: 10px !important;
      display: block;
      margin: 0 auto;
    }
  /* Client Name (optional personalization) */
  .client-name {
    font-size: 0.75rem !important;
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dark-secondary);
    margin: 0.25rem 0 0 0 !important;
  }

  /* Welcome Text */
  .welcome-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--text-dark-secondary);
    text-align: center;
    font-weight: 300;
    margin-bottom: 1.5rem;
  }

  /* Contract Viewer */
  .contract-viewer {
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
  }

  .contract-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;
    width: 100%;
    max-width: 880px;
  }

  .contract-help {
    font-size: 0.875rem;
    color: var(--text-dark-secondary);
    text-align: center;
    margin: 0 0 0.5rem 0;
  }

  #openDocumentBtn {
    width: auto;
    padding: 0.5rem 1.25rem;
    text-align: center;
    display: inline-block;
  }

  /* Signature Section */
  .signature-section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .signature-section label {
    font-size: 0.75rem;
    font-weight: 300;
    color: var(--text-dark-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  #signatureCanvas {
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: #ffffff;
    cursor: crosshair;
    width: 100%;
    height: 150px;
    display: block;
  }

  /* Documents Container */
  .documents-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .document-upload {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .document-upload label {
    font-size: 0.75rem;
    font-weight: 300;
    color: var(--text-dark-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .document-upload input[type="file"] {
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: var(--bg-dark-card);
    color: var(--text-dark-secondary);
    font-size: 0.75rem;
    font-weight: 300;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .document-upload input[type="file"]:hover {
    border-color: var(--accent-light);
  }

  .document-upload input[type="file"]::file-selector-button {
    padding: 0.375rem 1rem;
    margin-right: 1rem;
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: var(--bg-dark-main);
    color: var(--text-dark-primary);
    font-size: 0.75rem;
    font-weight: 300;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .document-upload input[type="file"]::file-selector-button:hover {
    background: var(--accent-light);
    color: var(--text-white);
    border-color: var(--accent-light);
  }

  .upload-status {
    font-size: 0.75rem;
    font-weight: 300;
    letter-spacing: 0.05em;
  }

  /* Questionnaire Form */
  .questionnaire-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .question-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .question-field label {
    font-size: 0.75rem;
    font-weight: 300;
    color: var(--text-dark-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }

  .question-field textarea {
    min-height: 100px;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: var(--bg-dark-card);
    color: var(--text-dark-primary);
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 300;
    line-height: 1.6;
    resize: vertical;
    transition: all 0.3s ease;
  }

  .question-field textarea:focus {
    outline: none;
    border-color: var(--accent-light);
    background: var(--bg-dark-main);
  }

  .question-field textarea::placeholder {
    color: var(--text-dark-secondary);
    opacity: 0.5;
  }

  /* Success Message */
  .success-message {
    text-align: center;
    padding: 2rem 0;
  }

  .success-icon {
    font-size: 4rem;
    font-weight: 200;
    color: var(--accent-light);
    margin-bottom: 1.5rem;
    line-height: 1;
  }

  .success-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--text-dark-secondary);
    font-weight: 300;
    margin: 0;
  }

  /* Calendar Section */
  .calendar-section {
    margin-top: 2rem;
  }

  .calendar-text {
    font-size: 0.875rem;
    font-weight: 300;
    color: var(--text-dark-primary);
    text-align: center;
    margin: 1rem 0 1.5rem 0;
    letter-spacing: 0.05em;
  }

  /* Error Text */
  .error-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--text-dark-secondary);
    text-align: center;
    font-weight: 300;
  }

  /* Buttons */
  .btn-primary,
  .btn-secondary {
    width: 100%;
    text-align: center;
  }

  /* Responsive Design */
  @media (max-width: 640px) {
    .welcome-container {
      padding: 1.5rem 1rem;
    }

    .step {
      max-width: 100%;
    }

    .step-wrapper {
      max-width: 100%;
      padding: 0 0.5rem;
    }

    .firm-logo img {
      /* Reduced 60% from previous mobile 40x20 -> now ~16x8 */
      max-width: 16px;
      max-height: 8px;
      width: 16px !important;
      height: 8px !important;
    }

    .firm-logo-img {
      width: 16px !important;
      height: 8px !important;
      max-width: 16px !important;
      max-height: 8px !important;
    }

    .contract-viewer iframe {
      width: 100% !important;
      height: 300px;
    }

    #signatureCanvas {
      height: 120px;
    }

    .form-header h1 {
      font-size: 1.5rem;
    }
  }

  @media (min-width: 640px) {
    .welcome-container {
      padding: 3rem 2rem;
    }
  }

  @media (min-width: 768px) {
    .step-wrapper {
      padding: 0 1rem;
    }
  }
</style>

<script define:vars={{ token }}>
  let portalData = null;
  let canvas, ctx;
  let isDrawing = false;

  async function loadPortalData() {
    try {
      const response = await fetch(`/api/portal/validate?token=${token}`);
      if (!response.ok) {
        showError();
        return;
      }
      
      portalData = await response.json();
      initializePortal();
    } catch (error) {
      showError();
    }
  }

  function initializePortal() {
    document.getElementById('loading').style.display = 'none';
    
    // Set firm info
    if (portalData.profile.firm_logo_url) {
      // insert image with explicit sizing to override intrinsic large dimensions
      document.getElementById('firmLogo').innerHTML = 
        `<img src="${portalData.profile.firm_logo_url}" alt="Logo" class="firm-logo-img" width="100" height="100" />`;
    }

    // Provide the contract file URL to the "open in new tab" button
    const openBtn = document.getElementById('openDocumentBtn');
    if (openBtn) {
      if (portalData.contract_template && portalData.contract_template.file_url) {
        openBtn.href = portalData.contract_template.file_url;
        openBtn.style.display = 'inline-block';
      } else {
        openBtn.style.display = 'none';
      }
    }
    
    // Set firm name
    document.getElementById('firmName').textContent = 
      portalData.profile.firm_name || 'ようこそ';
    
    // Optional: Set client name for personalization
    const clientNameElement = document.getElementById('clientName');
    if (portalData.client && portalData.client.name) {
      clientNameElement.textContent = portalData.client.name;
      clientNameElement.style.display = 'block';
    } else {
      clientNameElement.style.display = 'none';
    }
    
    // Show step 1
    document.getElementById('step1').style.display = 'flex';
    
    // Setup signature canvas
    setupSignatureCanvas();
  }

  function setupSignatureCanvas() {
    canvas = document.getElementById('signatureCanvas');
    if (!canvas) return;
    
    ctx = canvas.getContext('2d');
    
    // Set canvas size to match display size
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width;
    canvas.height = 150;
    
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';

    // Remove existing listeners to avoid duplicates
    const newCanvas = canvas.cloneNode(true);
    canvas.parentNode.replaceChild(newCanvas, canvas);
    canvas = newCanvas;
    ctx = canvas.getContext('2d');
    
    // Reset canvas properties after cloning
    canvas.width = rect.width;
    canvas.height = 150;
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';

    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch events
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      ctx.beginPath();
      ctx.moveTo(x, y);
      isDrawing = true;
    });

    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (!isDrawing) return;
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      ctx.lineTo(x, y);
      ctx.stroke();
      document.getElementById('signBtn').disabled = false;
    });

    canvas.addEventListener('touchend', () => {
      isDrawing = false;
    });
  }

  function startDrawing(e) {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  }

  function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
    ctx.stroke();
    document.getElementById('signBtn').disabled = false;
  }

  function stopDrawing() {
    isDrawing = false;
  }

  window.clearSignature = function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('signBtn').disabled = true;
  };

  window.nextStep = function(stepNumber) {
    document.querySelectorAll('.step').forEach(s => s.style.display = 'none');
    document.getElementById(`step${stepNumber}`).style.display = 'flex';

    if (stepNumber === 2) {
      // Reinitialize canvas after it becomes visible
      setTimeout(() => {
        setupSignatureCanvas();
      }, 100);
    } else if (stepNumber === 3) {
      // Load documents
      const container = document.getElementById('documentsContainer');
      container.innerHTML = '';
      portalData.client.required_documents.forEach(docType => {
        const div = document.createElement('div');
        div.className = 'document-upload';
        div.innerHTML = `
          <label>${docType.replace('_', ' ').toUpperCase()}</label>
          <input type="file" data-doctype="${docType}" class="doc-input" accept="image/*,application/pdf" />
          <span class="upload-status"></span>
        `;
        container.appendChild(div);
      });

      // Setup file upload
      document.querySelectorAll('.doc-input').forEach(input => {
        input.addEventListener('change', async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const docType = e.target.dataset.doctype;
          const formData = new FormData();
          formData.append('token', token);
          formData.append('document_type', docType);
          formData.append('file', file);

          const status = e.target.parentElement.querySelector('.upload-status');
          status.textContent = 'Subiendo...';

          try {
            const response = await fetch('/api/portal/upload-document', {
              method: 'POST',
              body: formData,
            });
            if (response.ok) {
              status.textContent = '✓ Subido';
              status.style.color = '#22c55e';
            } else {
              status.textContent = '✗ Error';
              status.style.color = '#ef4444';
            }
          } catch (error) {
            status.textContent = '✗ Error';
            status.style.color = '#ef4444';
          }
        });
      });
    } else if (stepNumber === 4) {
      // Load questionnaire
      const form = document.getElementById('questionnaireForm');
      form.innerHTML = '';
      portalData.questionnaire.questions
        .sort((a, b) => a.order_index - b.order_index)
        .forEach(question => {
          const div = document.createElement('div');
          div.className = 'question-field';
          div.innerHTML = `
            <label>${question.question_text}</label>
            <textarea data-qid="${question.id}" required></textarea>
          `;
          form.appendChild(div);
        });
    }
  };

  window.signContract = async function() {
    const signatureData = canvas.toDataURL();
    
    try {
      const response = await fetch('/api/portal/sign', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token,
          signature_data: signatureData,
          ip_address: 'client-ip', // In production, get from server
        }),
      });

      if (response.ok) {
        nextStep(3);
      } else {
        alert('Error al firmar el contrato');
      }
    } catch (error) {
      alert('Error al firmar el contrato');
    }
  };

  window.submitQuestionnaire = async function() {
    const textareas = document.querySelectorAll('#questionnaireForm textarea');
    const answers = Array.from(textareas).map(ta => ({
      question_id: ta.dataset.qid,
      answer_text: ta.value,
    }));

    try {
      const response = await fetch('/api/portal/submit-answers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token, answers }),
      });

      if (response.ok) {
        await completeProcess();
      } else {
        alert('Error al enviar respuestas');
      }
    } catch (error) {
      alert('Error al enviar respuestas');
    }
  };

  async function completeProcess() {
    try {
      await fetch('/api/portal/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token }),
      });

      // Show calendar link if available
      if (portalData.profile.calendar_link) {
        document.getElementById('calendarSection').style.display = 'block';
        document.getElementById('calendarLink').href = portalData.profile.calendar_link;
      }

      nextStep(5);
    } catch (error) {
      alert('Error al completar el proceso');
    }
  }

  function showError() {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('errorScreen').style.display = 'block';
  }

  // Initialize
  loadPortalData();
</script>

---
import Layout from "@/layouts/Dashboard.astro";
import Navigation from "@/components/Navigation.astro";
import PageHeader from "@/components/ui/PageHeader.astro";
import Button from "@/components/ui/Button.astro";
import Table from "@/components/ui/Table.astro";
import Badge from "@/components/ui/Badge.astro";
import { ClientService } from "@/services/ClientService";

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/signin");
}

const clients = await ClientService.getClients(user.id);
---

<Layout title="Clientes">
  <Navigation currentPage="clients" />

  <main class="flex-1 ml-60 p-16 max-w-7xl">
    <PageHeader
      title="Clientes"
      subtitle="Gestión de expedientes y salas de bienvenida"
    />

    <div class="mb-12 pb-8 border-b border-border-weak">
      <Button href="/dashboard/clients/new" variant="primary">
        NUEVA SALA DE BIENVENIDA
      </Button>
    </div>

    {
      clients && clients.length > 0 ? (
        <clients-list-live data-user-id={user.id}>
          <Table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Caso</th>
                <th>Estado</th>
                <th>Creado</th>
                <th class="text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {clients.map((client: any) => (
                <tr data-client-id={client.id}>
                  <td class="font-medium text-content-primary">
                    {client.client_name}
                  </td>
                  <td>{client.case_name}</td>
                  <td>
                    <Badge
                      variant={
                        client.status === "completed" ? "success" : "warning"
                      }
                      class="status-badge"
                    >
                      {client.status === "completed"
                        ? "COMPLETADO"
                        : "PENDIENTE"}
                    </Badge>
                  </td>
                  <td>
                    {new Date(client.created_at).toLocaleDateString("es-ES")}
                  </td>
                  <td>
                    <div class="flex items-center justify-end gap-4">
                      {client.status === "pending" ? (
                        <copy-link
                          class="text-xs font-light text-brand hover:text-brand-hover transition-colors cursor-pointer"
                          data-token={client.magic_link_token}
                        >
                          COPIAR LINK
                        </copy-link>
                      ) : (
                        <a
                          href={`/dashboard/clients/${client.id}/expediente`}
                          class="text-xs font-light text-content-secondary hover:text-content-primary transition-colors"
                        >
                          VER EXPEDIENTE
                        </a>
                      )}
                      <delete-trigger
                        class="text-xs font-light text-content-muted hover:text-status-error transition-colors cursor-pointer"
                        data-id={client.id}
                        data-action="/api/clients/delete"
                        data-confirm={`¿Estás seguro de eliminar el expediente de ${client.client_name}? Esta acción no se puede deshacer.`}
                      >
                        ELIMINAR
                      </delete-trigger>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </Table>
        </clients-list-live>
      ) : (
        <div class="py-24 text-center">
          <h3 class="text-2xl font-light text-content-secondary mb-4">
            No hay clientes aún
          </h3>
          <p class="text-sm font-light text-content-muted mb-12">
            Crea tu primer sala de bienvenida para comenzar
          </p>
          <Button href="/dashboard/clients/new" variant="secondary">
            NUEVA SALA DE BIENVENIDA
          </Button>
        </div>
      )
    }
  </main>
</Layout>

<script>
  import "@/components/interactive/CopyLink";
  import "@/components/interactive/DeleteTrigger";
  import "@/components/interactive/ClientsListLive";
</script>

---
import Layout from "@/layouts/Dashboard.astro";
import Navigation from "@/components/Navigation.astro";
import PageHeader from "@/components/ui/PageHeader.astro";
import Button from "@/components/ui/Button.astro";
import Table from "@/components/ui/Table.astro";
import Badge from "@/components/ui/Badge.astro";
import { ClientService } from "@/services/ClientService";

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/signin");
}

const clients = await ClientService.getClients(user.id);
---

<Layout title="Clientes">
  <Navigation currentPage="clients" />

  <main class="flex-1 ml-60 p-16 max-w-7xl">
    <PageHeader
      title="Clientes"
      subtitle="Gestión de expedientes y salas de bienvenida"
    />

    <div class="mb-12 pb-8 border-b border-border-weak">
      <Button href="/dashboard/clients/new" variant="primary">
        NUEVA SALA DE BIENVENIDA
      </Button>
    </div>

    {
      clients && clients.length > 0 ? (
        <Table>
          <tr slot="header">
            <th>Cliente</th>
            <th>Caso</th>
            <th>Estado</th>
            <th>Fecha</th>
            <th class="text-right">Acciones</th>
          </tr>
          {clients.map((client) => (
            <tr>
              <td class="font-medium text-content-primary">
                {client.client_name}
              </td>
              <td>{client.case_name}</td>
              <td>
                <Badge
                  variant={client.status === "pending" ? "warning" : "success"}
                >
                  {client.status === "pending" ? "Pendiente" : "Completado"}
                </Badge>
              </td>
              <td>{new Date(client.created_at).toLocaleDateString("es-MX")}</td>
              <td class="text-right">
                <div class="flex justify-end gap-4 items-center">
                  {client.status === "pending" ? (
                    <button
                      class="text-xs font-light text-brand hover:text-brand-hover transition-colors copy-link-btn"
                      data-token={client.magic_link_token}
                      type="button"
                    >
                      COPIAR LINK
                    </button>
                  ) : (
                    <a
                      href={`/dashboard/clients/${client.id}/expediente`}
                      class="text-xs font-light text-content-secondary hover:text-content-primary transition-colors"
                    >
                      VER EXPEDIENTE
                    </a>
                  )}
                  <button
                    class="text-xs font-light text-content-muted hover:text-status-error transition-colors delete-client-btn"
                    data-id={client.id}
                    data-name={client.client_name}
                    type="button"
                  >
                    ELIMINAR
                  </button>
                </div>
              </td>
            </tr>
          ))}
        </Table>
      ) : (
        <div class="py-24 text-center">
          <h3 class="text-2xl font-light text-content-secondary mb-4">
            No hay clientes aún
          </h3>
          <p class="text-sm font-light text-content-muted mb-12">
            Crea tu primera sala de bienvenida para comenzar
          </p>
          <Button href="/dashboard/clients/new" variant="secondary">
            NUEVA SALA DE BIENVENIDA
          </Button>
        </div>
      )
    }

    <div
      id="notification"
      class="fixed top-8 right-8 px-8 py-4 bg-surface-highlight border border-border text-content-primary text-sm font-light rounded shadow-lg translate-x-full opacity-0 transition-all duration-300"
    >
    </div>
  </main>
</Layout>

<script>
  function initPage() {
    const notification = document.getElementById("notification");
    const mainContainer = document.querySelector("main");

    function showNotification(message: string) {
      if (!notification) return;
      notification.textContent = message;
      notification.classList.remove("translate-x-full", "opacity-0");
      setTimeout(() => {
        notification.classList.add("translate-x-full", "opacity-0");
      }, 3000);
    }

    if (!mainContainer) return;

    mainContainer.addEventListener("click", async (e) => {
      const target = e.target as HTMLElement;

      // Copy Link
      if (target.matches(".copy-link-btn")) {
        const token = target.dataset.token;
        if (!token) return;
        const link = `${window.location.origin}/portal/${token}`;
        try {
          await navigator.clipboard.writeText(link);
          showNotification("Link copiado al portapapeles");
        } catch (err) {
          console.error("Error copying link:", err);
          showNotification("Error al copiar link");
        }
      }

      // Delete Client
      if (target.matches(".delete-client-btn")) {
        const id = target.dataset.id;
        const name = target.dataset.name;

        if (
          !id ||
          !confirm(
            `¿Estás seguro de eliminar el expediente de ${name}? Esta acción no se puede deshacer.`,
          )
        ) {
          return;
        }

        try {
          const response = await fetch("/api/clients/delete", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });

          if (response.ok) {
            showNotification("Cliente eliminado correctamente");
            setTimeout(() => window.location.reload(), 1500);
          } else {
            showNotification("Error al eliminar cliente");
          }
        } catch (error) {
          console.error("Error deleting client:", error);
          showNotification("Error al eliminar cliente");
        }
      }
    });
  }

  initPage();
  document.addEventListener("astro:page-load", initPage);
</script>

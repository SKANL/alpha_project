---
import Layout from "@/layouts/Dashboard.astro";
import Navigation from "@/components/Navigation.astro";
import PageHeader from "@/components/ui/PageHeader.astro";
import Input from "@/components/ui/Input.astro";
import Button from "@/components/ui/Button.astro";
import { ProfileService } from "@/services/ProfileService";

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/signin");
}

const profile = await ProfileService.getProfile(user.id);
---

<Layout title="Despacho">
  <Navigation currentPage="profile" />

  <main class="flex-1 ml-60 p-16 max-w-5xl">
    <PageHeader title="Despacho" subtitle="Configuración de tu firma legal" />

    <profile-form>
      <form id="profileForm" class="max-w-2xl flex flex-col gap-8">
        <Input
          label="Nombre del Despacho"
          type="text"
          id="firm_name"
          name="firm_name"
          value={profile?.firm_name || ""}
          required
        />

        <div class="flex flex-col gap-2">
          <label
            class="text-xs uppercase tracking-widest text-content-secondary font-light"
          >
            Logo
          </label>
          <input
            type="file"
            id="logo"
            name="logo"
            accept="image/*"
            class="w-full bg-transparent border-b border-border py-4 text-content-primary text-base font-light focus:outline-none focus:border-brand transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-sm file:border-0 file:text-xs file:font-medium file:bg-surface-highlight file:text-content-primary hover:file:bg-surface-highlight/80"
          />
          {
            profile?.firm_logo_url && (
              <div class="mt-8 p-8 bg-surface-highlight/20 border border-border-weak rounded inline-block">
                <img
                  src={profile.firm_logo_url}
                  alt="Logo"
                  class="max-w-[200px] max-h-[100px] object-contain block"
                />
              </div>
            )
          }
        </div>

        <Input
          label="Link de Agenda"
          type="url"
          id="calendar_link"
          name="calendar_link"
          value={profile?.calendar_link || ""}
          placeholder="https://calendly.com/tu-usuario"
          hint="Este link se mostrará al cliente al final del proceso de bienvenida"
        />

        <div class="pt-8">
          <Button type="submit" variant="secondary"> GUARDAR CAMBIOS </Button>
        </div>
      </form>
    </profile-form>

    <div
      id="successMessage"
      class="fixed top-8 right-8 px-8 py-4 bg-surface-highlight border border-border text-content-primary text-sm font-light rounded shadow-lg translate-x-full opacity-0 transition-all duration-300"
    >
      Perfil actualizado correctamente
    </div>
  </main>
</Layout>

<script>
  import "@/components/interactive/ProfileForm";
</script>

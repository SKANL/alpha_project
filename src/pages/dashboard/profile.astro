---
import Layout from "../../layouts/Layout.astro";
import Navigation from "../../components/Navigation.astro";
import { supabase } from "../../lib/supabase";

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

const session = await supabase.auth.setSession({
  refresh_token: refreshToken.value,
  access_token: accessToken.value,
});

if (session.error || !session.data.user) {
  return Astro.redirect("/signin");
}

const user = session.data.user;

const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("user_id", user.id)
  .single();
---

<Layout title="Despacho">
  <div class="dashboard-container">
    <Navigation currentPage="profile" />
    
    <main class="dashboard-main">
      <header class="page-header">
        <h1 class="page-title">Despacho</h1>
        <p class="page-subtitle">Configuración de tu firma legal</p>
      </header>

      <form id="profileForm" class="content-form">
        <div class="form-row">
          <label for="firm_name" class="form-label">Nombre del Despacho</label>
          <input
            type="text"
            id="firm_name"
            name="firm_name"
            value={profile?.firm_name || ""}
            required
            class="form-input"
          />
        </div>

        <div class="form-row">
          <label for="logo" class="form-label">Logo</label>
          <input
            type="file"
            id="logo"
            name="logo"
            accept="image/*"
            class="form-input-file"
          />
          {profile?.firm_logo_url && (
            <div class="logo-preview">
              <img src={profile.firm_logo_url} alt="Logo" />
            </div>
          )}
        </div>

        <div class="form-row">
          <label for="calendar_link" class="form-label">Link de Agenda</label>
          <input
            type="url"
            id="calendar_link"
            name="calendar_link"
            value={profile?.calendar_link || ""}
            placeholder="https://calendly.com/tu-usuario"
            class="form-input"
          />
          <span class="form-hint">
            Este link se mostrará al cliente al final del proceso de bienvenida
          </span>
        </div>

        <button type="submit" class="submit-btn">
          Guardar Cambios
        </button>
      </form>

      <div id="successMessage" class="success-toast">
        Perfil actualizado correctamente
      </div>
    </main>
  </div>
</Layout>

<style>
  .dashboard-container {
    display: flex;
    min-height: 100vh;
    background: #0a0a0a;
  }

  .dashboard-main {
    flex: 1;
    margin-left: 240px;
    padding: 4rem 6rem;
    max-width: 1200px;
  }

  .page-header {
    margin-bottom: 4rem;
  }

  .page-title {
    font-size: 2rem;
    font-weight: 300;
    letter-spacing: 0.02em;
    color: rgba(255, 255, 255, 0.95);
    margin-bottom: 0.5rem;
  }

  .page-subtitle {
    font-size: 0.875rem;
    font-weight: 300;
    letter-spacing: 0.05em;
    color: rgba(255, 255, 255, 0.4);
  }

  .content-form {
    max-width: 600px;
  }

  .form-row {
    margin-bottom: 3rem;
  }

  .form-label {
    display: block;
    font-size: 0.75rem;
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.5);
    margin-bottom: 1rem;
  }

  .form-input,
  .form-input-file {
    width: 100%;
    padding: 1rem 0;
    background: transparent;
    border: none;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
    font-size: 1rem;
    font-weight: 300;
    transition: border-color 0.3s ease;
  }

  .form-input:focus,
  .form-input-file:focus {
    outline: none;
    border-bottom-color: rgba(255, 255, 255, 0.3);
  }

  .form-input::placeholder {
    color: rgba(255, 255, 255, 0.25);
  }

  .form-hint {
    display: block;
    margin-top: 0.75rem;
    font-size: 0.75rem;
    font-weight: 300;
    color: rgba(255, 255, 255, 0.3);
    line-height: 1.5;
  }

  .logo-preview {
    margin-top: 2rem;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 2px;
    display: inline-block;
  }

  .logo-preview img {
    max-width: 200px;
    max-height: 100px;
    object-fit: contain;
    display: block;
  }

  .submit-btn {
    margin-top: 3rem;
    padding: 1rem 3rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.75rem;
    font-weight: 300;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 2px;
  }

  .submit-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.4);
  }

  .success-toast {
    position: fixed;
    top: 2rem;
    right: 2rem;
    padding: 1rem 2rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.875rem;
    font-weight: 300;
    border-radius: 2px;
    display: none;
    animation: slideInRight 0.3s ease-out;
  }

  .success-toast.show {
    display: block;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }
</style><script>
  const form = document.getElementById('profileForm') as HTMLFormElement;
  const successMessage = document.getElementById('successMessage');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(form);

    try {
      const response = await fetch('/api/profile/update', {
        method: 'POST',
        body: formData,
      });

      if (response.ok) {
        // Read returned profile and update the DOM immediately
        const body = await response.json();

        // Update input values if returned
        const nameInput = document.getElementById('firm_name') as HTMLInputElement | null;
        const calendarInput = document.getElementById('calendar_link') as HTMLInputElement | null;
        if (body?.firm_name && nameInput) nameInput.value = body.firm_name;
        if (body?.calendar_link && calendarInput) calendarInput.value = body.calendar_link;

        // Update logo preview if provided
        if (body?.firm_logo_url) {
          const logoPreview = document.querySelector('.logo-preview') as HTMLElement | null;
          if (logoPreview) {
            // replace or create img inside preview
            let img = logoPreview.querySelector('img') as HTMLImageElement | null;
            if (!img) {
              img = document.createElement('img');
              logoPreview.appendChild(img);
            }
            img.src = body.firm_logo_url;
            img.alt = 'Logo';
          }
        }

        // Show success toast briefly
        successMessage?.classList.add('show');
        setTimeout(() => {
          successMessage?.classList.remove('show');
        }, 3000);
      } else {
        const error = await response.json().catch(() => ({ error: 'Unknown error' }));
        alert('Error: ' + (error?.error || JSON.stringify(error)));
      }
    } catch (error) {
      alert('Error al guardar el perfil');
    }
  });
</script>

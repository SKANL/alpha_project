---
import Layout from "@/layouts/Dashboard.astro";
import Navigation from "@/components/Navigation.astro";
import PageHeader from "@/components/ui/PageHeader.astro";
import Button from "@/components/ui/Button.astro";
import Modal from "@/components/ui/Modal.astro";
import Input from "@/components/ui/Input.astro";
import { TemplateService } from "@/services/TemplateService";
import type { QuestionnaireTemplate } from "@/lib/types";

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/signin");
}

const questionnaires = await TemplateService.getQuestionnaireTemplates(user.id);
---

<Layout title="Plantillas de Cuestionarios">
  <Navigation currentPage="questionnaires" />

  <main class="flex-1 ml-60 p-16 max-w-7xl">
    <PageHeader
      title="Cuestionarios"
      subtitle="Plantillas de preguntas para clientes"
    />

    <div class="mb-12 pb-8 border-b border-border-weak">
      <Button
        id="openModalBtn"
        variant="primary"
        onclick="window.dispatchEvent(new CustomEvent('toggle-modal-questionnaireModal'))"
      >
        NUEVO CUESTIONARIO
      </Button>
    </div>

    {
      questionnaires && questionnaires.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-px bg-border-weak border border-border-weak">
          {questionnaires.map(
            (q: QuestionnaireTemplate & { questions?: any[] }) => (
              <div class="bg-surface-card p-8 flex flex-col justify-between gap-6 hover:bg-surface-highlight/20 transition-colors duration-200">
                <div>
                  <h3 class="text-sm font-medium text-content-primary mb-2">
                    {q.name}
                  </h3>
                  <p class="text-xs font-light text-content-muted">
                    {q.questions?.length || 0} preguntas
                  </p>
                </div>
                <div class="flex gap-6">
                  <delete-trigger
                    class="text-xs text-content-secondary hover:text-status-error cursor-pointer font-medium"
                    data-id={q.id}
                    data-action="/api/templates/questionnaires/delete"
                    data-confirm="¿Eliminar este cuestionario?"
                  >
                    Eliminar
                  </delete-trigger>
                </div>
              </div>
            ),
          )}
        </div>
      ) : (
        <div class="py-24 text-center">
          <h3 class="text-2xl font-light text-content-secondary mb-4">
            No hay cuestionarios aún
          </h3>
          <p class="text-sm font-light text-content-muted mb-12">
            Crea tu primer cuestionario
          </p>
        </div>
      )
    }

    <Modal id="questionnaireModal" title="Nuevo Cuestionario">
      <questionnaire-form data-modal-id="questionnaireModal">
        <form id="questionnaireForm" class="flex flex-col gap-6">
          <Input
            label="Nombre del Cuestionario"
            type="text"
            id="name"
            name="name"
            placeholder="Cuestionario de Divorcio"
            required
          />

          <div class="flex flex-col gap-4">
            <div class="flex justify-between items-center">
              <label
                class="text-xs uppercase tracking-widest text-content-secondary font-light"
              >
                Preguntas
              </label>
              <Button
                type="button"
                variant="ghost"
                size="sm"
                id="addQuestionBtn"
                class="text-xs text-brand hover:text-brand-hover p-0 h-auto"
              >
                + AGREGAR PREGUNTA
              </Button>
            </div>

            <div
              id="questionsContainer"
              class="flex flex-col gap-4 max-h-[40vh] overflow-y-auto pr-2"
            >
              <!-- Questions will be added here -->
            </div>
          </div>

          <div class="flex justify-end gap-4 mt-4">
            <Button
              type="button"
              variant="ghost"
              onclick="window.dispatchEvent(new CustomEvent('toggle-modal-questionnaireModal'))"
            >
              CANCELAR
            </Button>
            <Button type="submit" variant="primary"> GUARDAR </Button>
          </div>
        </form>
      </questionnaire-form>
    </Modal>
  </main>
</Layout>

<script>
  import "@/components/interactive/QuestionnaireForm";
  import "@/components/interactive/DeleteTrigger";
</script>

---
import Layout from "@/layouts/Dashboard.astro";
import Navigation from "@/components/Navigation.astro";
import PageHeader from "@/components/ui/PageHeader.astro";
import Button from "@/components/ui/Button.astro";
import Modal from "@/components/ui/Modal.astro";
import Input from "@/components/ui/Input.astro";
import { TemplateService } from "@/services/TemplateService";
import type { QuestionnaireTemplate } from "@/lib/types";

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/signin");
}

const questionnaires = await TemplateService.getQuestionnaireTemplates(user.id);
---

<Layout title="Plantillas de Cuestionarios">
  <Navigation currentPage="questionnaires" />

  <main class="flex-1 ml-60 p-16 max-w-7xl">
    <PageHeader
      title="Cuestionarios"
      subtitle="Plantillas de preguntas para clientes"
    />

    <div class="mb-12 pb-8 border-b border-border-weak">
      <Button id="openModalBtn" variant="primary"> NUEVO CUESTIONARIO </Button>
    </div>

    {
      questionnaires && questionnaires.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-px bg-border-weak border border-border-weak">
          {questionnaires.map(
            (q: QuestionnaireTemplate & { questions?: any[] }) => (
              <div class="bg-surface-card p-8 flex flex-col justify-between gap-6 hover:bg-surface-highlight/20 transition-colors duration-200">
                <div>
                  <h3 class="text-sm font-medium text-content-primary mb-2">
                    {q.name}
                  </h3>
                  <p class="text-xs font-light text-content-muted">
                    {q.questions?.length || 0} preguntas
                  </p>
                </div>
                <div class="flex gap-6">
                  <Button
                    variant="ghost"
                    size="sm"
                    class="text-xs text-content-secondary hover:text-status-error delete-btn"
                    data-id={q.id}
                  >
                    Eliminar
                  </Button>
                </div>
              </div>
            ),
          )}
        </div>
      ) : (
        <div class="py-24 text-center">
          <h3 class="text-2xl font-light text-content-secondary mb-4">
            No hay cuestionarios aún
          </h3>
          <p class="text-sm font-light text-content-muted mb-12">
            Crea tu primer cuestionario
          </p>
        </div>
      )
    }

    <Modal id="questionnaireModal" title="Nuevo Cuestionario">
      <form id="questionnaireForm" class="flex flex-col gap-6">
        <Input
          label="Nombre del Cuestionario"
          type="text"
          id="name"
          name="name"
          placeholder="Cuestionario de Divorcio"
          required
        />

        <div class="flex flex-col gap-4">
          <div class="flex justify-between items-center">
            <label
              class="text-xs uppercase tracking-widest text-content-secondary font-light"
            >
              Preguntas
            </label>
            <Button
              type="button"
              variant="ghost"
              size="sm"
              id="addQuestionBtn"
              class="text-xs text-brand hover:text-brand-hover p-0 h-auto"
            >
              + AGREGAR PREGUNTA
            </Button>
          </div>

          <div
            id="questionsContainer"
            class="flex flex-col gap-4 max-h-[40vh] overflow-y-auto pr-2"
          >
            <!-- Questions will be added here -->
          </div>
        </div>

        <div class="flex justify-end gap-4 mt-4">
          <Button type="button" variant="ghost" id="closeModalBtn">
            CANCELAR
          </Button>
          <Button type="submit" variant="primary"> GUARDAR </Button>
        </div>
      </form>
    </Modal>
  </main>
</Layout>

<script>
  function initQuestionnaires() {
    const modal = document.getElementById("questionnaireModal");
    const form = document.getElementById(
      "questionnaireForm",
    ) as HTMLFormElement;
    const openBtn = document.getElementById("openModalBtn");
    const closeBtn = document.getElementById("closeModalBtn");
    const addQuestionBtn = document.getElementById("addQuestionBtn");
    const questionsContainer = document.getElementById("questionsContainer");

    const toggleModal = () => {
      window.dispatchEvent(new CustomEvent("toggle-modal-questionnaireModal"));
    };

    openBtn?.addEventListener("click", toggleModal);
    closeBtn?.addEventListener("click", toggleModal);

    let questionCount = 0;

    const addQuestionInput = () => {
      const div = document.createElement("div");
      div.className = "flex gap-2 items-start animate-fade-in-up";
      div.innerHTML = `
        <div class="flex-1">
          <input
            type="text"
            name="questions[]"
            placeholder="Escribe la pregunta..."
            required
            class="w-full bg-surface-card border border-border rounded px-3 py-2 text-content-primary text-sm focus:outline-none focus:border-brand focus:ring-1 focus:ring-brand-light"
          />
        </div>
        <button type="button" class="text-content-muted hover:text-status-error p-2 remove-question">
          ×
        </button>
      `;

      div.querySelector(".remove-question")?.addEventListener("click", () => {
        div.remove();
      });

      questionsContainer?.appendChild(div);
      questionCount++;
    };

    // Add initial question
    if (questionsContainer && questionsContainer.children.length === 0) {
      addQuestionInput();
    }

    addQuestionBtn?.addEventListener("click", addQuestionInput);

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      // Get questions array manually since FormData.getAll might behave differently across browsers/environments
      const questions = Array.from(
        form.querySelectorAll('input[name="questions[]"]'),
      )
        .map((input) => (input as HTMLInputElement).value)
        .filter(Boolean);

      const data = {
        name: formData.get("name"),
        questions: questions,
      };

      try {
        const response = await fetch("/api/templates/questionnaires/create", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        if (response.ok) {
          window.location.reload();
        } else {
          alert("Error al crear cuestionario");
        }
      } catch (error) {
        console.error(error);
        alert("Error al crear cuestionario");
      }
    });

    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        if (!confirm("¿Eliminar cuestionario?")) return;
        const id = (btn as HTMLElement).dataset.id;
        try {
          const response = await fetch("/api/templates/questionnaires/delete", {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id }),
          });
          if (response.ok) window.location.reload();
        } catch (error) {
          console.error(error);
          alert("Error al eliminar cuestionario");
        }
      });
    });
  }

  initQuestionnaires();
  document.addEventListener("astro:page-load", initQuestionnaires);
</script>

---
import Layout from "@/layouts/Dashboard.astro";
import Navigation from "@/components/Navigation.astro";
import PageHeader from "@/components/ui/PageHeader.astro";
import Button from "@/components/ui/Button.astro";
import Modal from "@/components/ui/Modal.astro";
import type { ContractTemplate } from "@/lib/types";
import Input from "@/components/ui/Input.astro";
import { TemplateService } from "@/services/TemplateService";

const { user } = Astro.locals;

if (!user) {
  return Astro.redirect("/auth/signin");
}

const contracts = await TemplateService.getContractTemplates(user.id);
---

<Layout title="Plantillas de Contratos">
  <Navigation currentPage="contracts" />

  <main class="flex-1 ml-60 p-16 max-w-7xl">
    <PageHeader
      title="Contratos"
      subtitle="Plantillas reutilizables de contratos"
    />

    <div class="mb-12 pb-8 border-b border-border-weak">
      <Button
        id="openModalBtn"
        variant="primary"
        onclick="window.dispatchEvent(new CustomEvent('toggle-modal-contractModal'))"
      >
        NUEVA PLANTILLA
      </Button>
    </div>

    {
      contracts && contracts.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-px bg-border-weak border border-border-weak">
          {contracts.map((contract: ContractTemplate) => (
            <div class="bg-surface-card p-8 flex flex-col justify-between gap-6 hover:bg-surface-highlight/20 transition-colors duration-200">
              <div>
                <h3 class="text-sm font-medium text-content-primary mb-1">
                  {contract.name}
                </h3>
                <p class="text-xs font-light text-content-muted">
                  {new Date(contract.created_at).toLocaleDateString("es-MX")}
                </p>
              </div>
              <div class="flex gap-6">
                <Button
                  href={contract.file_url}
                  target="_blank"
                  variant="ghost"
                  size="sm"
                  class="text-xs"
                >
                  Ver PDF
                </Button>
                <delete-trigger
                  class="text-xs text-content-secondary hover:text-status-error cursor-pointer font-medium"
                  data-id={contract.id}
                  data-action="/api/templates/contracts/delete"
                  data-confirm="¿Eliminar esta plantilla?"
                >
                  Eliminar
                </delete-trigger>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="py-24 text-center">
          <h3 class="text-2xl font-light text-content-secondary mb-4">
            No hay plantillas aún
          </h3>
          <p class="text-sm font-light text-content-muted mb-12">
            Sube tu primera plantilla de contrato
          </p>
        </div>
      )
    }

    <Modal id="contractModal" title="Nueva Plantilla de Contrato">
      <contract-form data-modal-id="contractModal">
        <form id="contractForm" class="flex flex-col gap-6">
          <Input
            label="Nombre"
            type="text"
            id="name"
            name="name"
            placeholder="Contrato de Servicios"
            required
          />

          <div class="flex flex-col gap-2">
            <label
              class="text-xs uppercase tracking-widest text-content-secondary font-light"
            >
              Archivo PDF
            </label>
            <input
              type="file"
              id="file"
              name="file"
              accept=".pdf"
              required
              class="w-full bg-transparent border-b border-border py-2 text-content-primary text-sm font-light focus:outline-none focus:border-brand transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-sm file:border-0 file:text-xs file:font-medium file:bg-surface-highlight file:text-content-primary hover:file:bg-surface-highlight/80"
            />
          </div>

          <div class="flex justify-end gap-4 mt-4">
            <Button
              type="button"
              variant="ghost"
              onclick="window.dispatchEvent(new CustomEvent('toggle-modal-contractModal'))"
            >
              CANCELAR
            </Button>
            <Button type="submit" variant="primary"> GUARDAR </Button>
          </div>
        </form>
      </contract-form>
    </Modal>
  </main>
</Layout>

<script>
  import "@/components/interactive/ContractForm";
  import "@/components/interactive/DeleteTrigger";
</script>

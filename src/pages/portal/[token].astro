---
import Layout from "@/layouts/Layout.astro";
import Button from "@/components/ui/Button.astro";
import Input from "@/components/ui/Input.astro";
import Card from "@/components/ui/Card.astro";
import { supabase } from "@/lib/supabase";

const { token } = Astro.params;

if (!token) {
  return Astro.redirect("/");
}

// 1. Validate Token & Get Client Data
const { data: client, error } = await supabase
  .from("clients")
  .select(
    `
    *,
    contract_template:contract_templates(*),
    questionnaire_template:questionnaire_templates(*)
  `,
  )
  .eq("magic_link_token", token)
  .single();

if (error || !client) {
  return Astro.redirect("/404");
}

// 2. Get Profile (Lawyer) Info for branding
const { data: profile } = await supabase
  .from("profiles")
  .select("*")
  .eq("user_id", client.user_id)
  .single();

// 3. Determine Current Step
// steps: 'welcome' | 'contract' | 'questionnaire' | 'documents' | 'calendar' | 'completed'
let currentStep = "welcome";

if (client.status === "completed") {
  currentStep = "completed";
} else if (client.contract_signed) {
  currentStep = "questionnaire";
  if (client.questionnaire_answers) {
    currentStep = "documents";
    // Check if documents are uploaded (simplified check)
    // In a real app, we'd check the storage or a 'documents_uploaded' flag
    // For now, let's assume if they are here, they might be done or uploading
    // We'll handle state transitions via client-side logic mostly for this single-page flow
  }
}

const clientId = client.id;
---

<Layout title={`Bienvenido | ${profile?.firm_name || "Legal Studio"}`}>
  <div class="min-h-screen bg-surface-base flex flex-col">
    <!-- Header -->
    <header class="py-8 px-4 border-b border-border-weak text-center">
      {
        profile?.firm_logo_url && (
          <img
            src={profile.firm_logo_url}
            alt="Logo"
            class="h-12 mx-auto mb-4 object-contain"
          />
        )
      }
      <h1
        class="text-sm font-light tracking-widest uppercase text-content-secondary"
      >
        {profile?.firm_name || "LEGAL STUDIO"}
      </h1>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl animate-fade-in-up" id="mainContainer">
        <!-- STEP: WELCOME -->
        <div id="step-welcome" class="step-content text-center">
          <h2 class="text-4xl font-light text-content-primary mb-4">
            Hola, {client.client_name}
          </h2>
          <p class="text-lg font-light text-content-secondary mb-12">
            Bienvenido a tu proceso de alta para el caso <span
              class="text-content-primary">"{client.case_name}"</span
            >.
          </p>
          <div class="grid gap-4 max-w-md mx-auto mb-12 text-left">
            <div
              class="flex items-center gap-4 p-4 bg-surface-card border border-border rounded"
            >
              <span class="text-brand text-xl">1</span>
              <span class="text-content-secondary font-light"
                >Firma de Contrato</span
              >
            </div>
            <div
              class="flex items-center gap-4 p-4 bg-surface-card border border-border rounded"
            >
              <span class="text-brand text-xl">2</span>
              <span class="text-content-secondary font-light"
                >Cuestionario Inicial</span
              >
            </div>
            <div
              class="flex items-center gap-4 p-4 bg-surface-card border border-border rounded"
            >
              <span class="text-brand text-xl">3</span>
              <span class="text-content-secondary font-light"
                >Carga de Documentos</span
              >
            </div>
          </div>
          <Button id="startBtn" variant="primary" size="lg"> COMENZAR </Button>
        </div>

        <!-- STEP: CONTRACT -->
        <div id="step-contract" class="step-content hidden">
          <Card>
            <h3 class="text-xl font-light text-content-primary mb-6">
              1. Contrato de Servicios
            </h3>
            <div
              class="bg-surface-base border border-border rounded p-4 h-96 overflow-y-auto mb-6 text-sm font-light text-content-secondary leading-relaxed"
            >
              <p class="mb-4">
                Por favor lee detenidamente el siguiente contrato de servicios
                legales.
              </p>
              <!-- PDF Viewer or Text would go here. For now, a placeholder link -->
              <div
                class="flex flex-col items-center justify-center h-full gap-4"
              >
                <span class="text-content-muted">Vista previa del contrato</span
                >
                <a
                  href={client.contract_template?.file_url}
                  target="_blank"
                  class="text-brand hover:underline"
                >
                  Abrir PDF en nueva pestaña
                </a>
              </div>
            </div>
            <div class="flex items-center gap-3 mb-8">
              <input
                type="checkbox"
                id="acceptContract"
                class="w-5 h-5 accent-brand"
              />
              <label
                for="acceptContract"
                class="text-sm font-light text-content-secondary"
              >
                He leído y acepto los términos y condiciones del contrato.
              </label>
            </div>
            <div class="flex justify-end">
              <Button id="signContractBtn" variant="primary" disabled>
                FIRMAR Y CONTINUAR
              </Button>
            </div>
          </Card>
        </div>

        <!-- STEP: QUESTIONNAIRE -->
        <div id="step-questionnaire" class="step-content hidden">
          <Card>
            <h3 class="text-xl font-light text-content-primary mb-6">
              2. Cuestionario Inicial
            </h3>
            <form id="questionnaireForm" class="flex flex-col gap-6">
              {
                client.questionnaire_template?.questions?.map(
                  (q: string, index: number) => (
                    <Input label={q} name={`q_${index}`} required />
                  ),
                )
              }
              <div class="flex justify-end pt-4">
                <Button type="submit" variant="primary">
                  ENVIAR RESPUESTAS
                </Button>
              </div>
            </form>
          </Card>
        </div>

        <!-- STEP: DOCUMENTS -->
        <div id="step-documents" class="step-content hidden">
          <Card>
            <h3 class="text-xl font-light text-content-primary mb-6">
              3. Documentos Requeridos
            </h3>
            <p class="text-sm font-light text-content-secondary mb-8">
              Por favor sube los siguientes documentos en formato PDF o imagen.
            </p>
            <form id="docsForm" class="flex flex-col gap-6">
              {
                client.required_documents?.map((doc: string) => (
                  <div class="flex flex-col gap-2">
                    <label class="text-xs uppercase tracking-widest text-content-secondary font-light">
                      {doc.replace(/_/g, " ")}
                    </label>
                    <input
                      type="file"
                      name={doc}
                      required
                      class="w-full bg-surface-base border border-border rounded px-3 py-2 text-content-primary text-sm font-light focus:outline-none focus:border-brand transition-colors file:mr-4 file:py-2 file:px-4 file:rounded-sm file:border-0 file:text-xs file:font-medium file:bg-surface-highlight file:text-content-primary hover:file:bg-surface-highlight/80"
                    />
                  </div>
                ))
              }
              <div class="flex justify-end pt-4">
                <Button type="submit" variant="primary">
                  SUBIR DOCUMENTOS
                </Button>
              </div>
            </form>
          </Card>
        </div>

        <!-- STEP: CALENDAR -->
        <div id="step-calendar" class="step-content hidden text-center">
          <h2 class="text-3xl font-light text-content-primary mb-4">
            ¡Todo listo!
          </h2>
          <p class="text-lg font-light text-content-secondary mb-12">
            Hemos recibido tu información correctamente.
          </p>

          {
            profile?.calendar_link ? (
              <div class="animate-fade-in-up">
                <p class="text-sm font-light text-content-muted mb-6">
                  Para finalizar, por favor agenda tu cita de bienvenida.
                </p>
                <Button
                  href={profile.calendar_link}
                  target="_blank"
                  variant="primary"
                  size="lg"
                >
                  AGENDAR CITA
                </Button>
              </div>
            ) : (
              <div class="p-8 bg-surface-card border border-border rounded">
                <p class="text-content-primary">
                  Nos pondremos en contacto contigo pronto.
                </p>
              </div>
            )
          }
        </div>
      </div>
    </main>
  </div>
</Layout>

<script define:vars={{ initialStep: currentStep, clientId }}>
  // State Management
  const steps = [
    "welcome",
    "contract",
    "questionnaire",
    "documents",
    "calendar",
  ];
  let currentStepIndex = steps.indexOf(
    initialStep === "completed" ? "calendar" : initialStep,
  );
  if (currentStepIndex === -1) currentStepIndex = 0;

  function showStep(index) {
    document
      .querySelectorAll(".step-content")
      .forEach((el) => el.classList.add("hidden"));
    const stepId = `step-${steps[index]}`;
    document.getElementById(stepId)?.classList.remove("hidden");
    window.scrollTo(0, 0);
  }

  // Initial Render
  showStep(currentStepIndex);

  // Event Listeners

  // 1. Welcome -> Contract
  document.getElementById("startBtn")?.addEventListener("click", () => {
    currentStepIndex = 1;
    showStep(currentStepIndex);
  });

  // 2. Contract Logic
  const acceptCheckbox = document.getElementById("acceptContract");
  const signBtn = document.getElementById("signContractBtn");

  acceptCheckbox?.addEventListener("change", (e) => {
    if (signBtn) signBtn.disabled = !e.target.checked;
  });

  signBtn?.addEventListener("click", async () => {
    try {
      signBtn.textContent = "FIRMANDO...";
      const response = await fetch("/api/portal/sign-contract", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ clientId }),
      });

      if (response.ok) {
        currentStepIndex = 2;
        showStep(currentStepIndex);
      } else {
        alert("Error al firmar contrato");
        signBtn.textContent = "FIRMAR Y CONTINUAR";
      }
    } catch (e) {
      alert("Error de conexión");
      signBtn.textContent = "FIRMAR Y CONTINUAR";
    }
  });

  // 3. Questionnaire Logic
  const qForm = document.getElementById("questionnaireForm");
  qForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = qForm.querySelector('button[type="submit"]');
    if (btn) btn.textContent = "ENVIANDO...";

    const formData = new FormData(qForm);
    const answers = {};
    formData.forEach((value, key) => {
      answers[key] = value;
    });

    try {
      const response = await fetch("/api/portal/submit-questionnaire", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ clientId, answers }),
      });

      if (response.ok) {
        currentStepIndex = 3;
        showStep(currentStepIndex);
      } else {
        alert("Error al enviar respuestas");
        if (btn) btn.textContent = "ENVIAR RESPUESTAS";
      }
    } catch (e) {
      alert("Error de conexión");
      if (btn) btn.textContent = "ENVIAR RESPUESTAS";
    }
  });

  // 4. Documents Logic
  const docsForm = document.getElementById("docsForm");
  docsForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const btn = docsForm.querySelector('button[type="submit"]');
    if (btn) btn.textContent = "SUBIENDO...";

    const formData = new FormData(docsForm);
    formData.append("clientId", clientId);

    try {
      const response = await fetch("/api/portal/upload-documents", {
        method: "POST",
        body: formData,
      });

      if (response.ok) {
        currentStepIndex = 4;
        showStep(currentStepIndex);
      } else {
        alert("Error al subir documentos");
        if (btn) btn.textContent = "SUBIR DOCUMENTOS";
      }
    } catch (e) {
      alert("Error de conexión");
      if (btn) btn.textContent = "SUBIR DOCUMENTOS";
    }
  });
</script>

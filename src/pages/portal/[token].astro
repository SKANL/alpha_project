---
import Layout from "@/layouts/Layout.astro";

const { token } = Astro.params;

if (!token) {
  return Astro.redirect("/");
}
---

<Layout title="Bienvenida">
  <div id="app" class="welcome-container">
    <!-- Loading Screen -->
    <div id="loading" class="loading-screen">
      <div class="loader"></div>
      <p class="loading-text">Cargando...</p>
    </div>

    <!-- Step 1: Welcome -->
    <div id="step1" class="step" style="display: none;">
      <div class="step-wrapper">
        <div id="firmLogo" class="firm-logo"></div>

        <div class="form-header">
          <h1 id="firmName">ようこそ</h1>
          <p id="clientName" class="client-name"></p>
          <p>welcome</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <p class="welcome-text">
            Te guiaremos paso a paso para completar tu proceso de incorporación.
            Solo tomará unos minutos.
          </p>

          <button class="btn-primary" onclick="nextStep(2)"> Comenzar </button>
        </div>
      </div>
    </div>

    <!-- Step 2: Contract -->
    <div id="step2" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>契約</h1>
          <p>contrato</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <div class="contract-viewer">
            <div class="contract-actions">
              <p class="contract-help">
                abre el documento en una nueva pestaña.
              </p>
              <a
                id="openDocumentBtn"
                class="btn-primary"
                target="_blank"
                rel="noopener noreferrer"
                href="#">Abrir documento en nueva pestaña</a
              >
            </div>
          </div>

          <div class="signature-section">
            <label for="signatureCanvas">Tu Firma Digital</label>
            <canvas id="signatureCanvas"></canvas>
            <button
              type="button"
              class="btn-secondary"
              onclick="clearSignature()"
            >
              Limpiar
            </button>
          </div>

          <button
            class="btn-primary"
            onclick="signContract()"
            disabled
            id="signBtn"
          >
            Aceptar y Firmar
          </button>
        </div>
      </div>
    </div>

    <!-- Step 3: Documents -->
    <div id="step3" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>書類</h1>
          <p>documentos</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <div id="documentsContainer" class="documents-container"></div>

          <button class="btn-primary" onclick="nextStep(4)"> Continuar </button>
        </div>
      </div>
    </div>

    <!-- Step 4: Questionnaire -->
    <div id="step4" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>質問</h1>
          <p>cuestionario</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container questionnaire-container">
          <div
            id="questionProgress"
            class="question-progress"
            style="display:none;"
          >
            <div class="progress-info">
              <span id="progressText">Pregunta 0 de 0</span>
            </div>
            <div class="progress-track">
              <div id="progressBar" class="progress-bar" style="width:0%"></div>
            </div>
          </div>

          <div class="question-actions">
            <button type="button" class="btn-secondary" onclick="nextStep(3)"
              >Atrás</button
            >
          </div>

          <form id="questionnaireForm" class="questionnaire-form" novalidate>
          </form>

          <div
            class="nav-row"
            style="display:flex;gap:0.75rem;margin-top:0.75rem;"
          >
            <button
              id="prevQuestionBtn"
              type="button"
              class="btn-secondary"
              onclick="prevQuestion()">Anterior</button
            >
            <button
              id="nextQuestionBtn"
              type="button"
              class="btn-primary"
              onclick="nextQuestion()">Siguiente</button
            >
          </div>
        </div>
      </div>
    </div>

    <!-- Step 5: Complete -->
    <div id="step5" class="step" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>完璧</h1>
          <p>perfecto</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <div class="success-message">
            <div class="success-icon">✓</div>
            <p class="success-text">
              Tu información ha sido recibida exitosamente. Pronto nos pondremos
              en contacto contigo.
            </p>
          </div>

          <div
            id="calendarSection"
            class="calendar-section"
            style="display: none;"
          >
            <div class="form-divider"></div>
            <p class="calendar-text">Agenda tu primera reunión</p>
            <a id="calendarLink" href="#" target="_blank" class="btn-primary">
              Agendar Reunión
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Error Screen -->
    <div id="errorScreen" class="error-screen" style="display: none;">
      <div class="step-wrapper">
        <div class="form-header">
          <h1>エラー</h1>
          <p>error</p>
        </div>

        <div class="form-divider"></div>

        <div class="form-container">
          <p id="errorMessage" class="error-text">
            Este link no es válido o ya fue utilizado.
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  /* --- Compact, consolidated styles for portal page --- */
  :root {
    --small: 0.75rem;
    --muted: var(--text-dark-secondary);
  }

  .welcome-container {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    background: var(--bg-dark-main);
  }

  .loading-screen,
  .error-screen {
    text-align: center;
    animation: fadeInUp 0.6s ease-out;
  }
  .loader {
    width: 40px;
    height: 40px;
    border: 2px solid var(--border-dark);
    border-top-color: var(--accent-light);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 1rem;
  }
  .loading-text {
    font-size: 0.875rem;
    font-weight: 300;
    color: var(--muted);
    letter-spacing: 0.05em;
  }
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .step {
    width: 100%;
    max-width: 1200px;
    animation: fadeInUp 0.6s ease-out;
    display: flex;
    justify-content: center;
  }
  .step-wrapper {
    width: 100%;
    max-width: 920px;
  }
  #step4 .step-wrapper {
    max-width: 100%;
    padding: 0 2rem;
  }

  .firm-logo {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 2rem;
  }
  .firm-logo img,
  .firm-logo-img {
    display: block;
    margin: 0 auto;
    object-fit: contain;
    opacity: 0.9;
    width: 20px;
    height: 10px;
    max-width: 20px;
    max-height: 10px;
  }
  .client-name {
    font-size: var(--small) !important;
    font-weight: 300;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
    margin: 0.25rem 0 0 0 !important;
  }

  .welcome-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--muted);
    text-align: center;
    font-weight: 300;
    margin-bottom: 1.5rem;
  }

  .contract-viewer {
    margin-bottom: 2rem;
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
  }
  .contract-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    align-items: center;
    width: 100%;
    max-width: 880px;
  }
  .contract-help {
    font-size: 0.875rem;
    color: var(--muted);
    text-align: center;
    margin-bottom: 0.5rem;
  }
  #openDocumentBtn {
    display: inline-block;
    padding: 0.5rem 1.25rem;
    text-align: center;
  }

  .signature-section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }
  .signature-section label {
    font-size: var(--small);
    font-weight: 300;
    color: var(--text-dark-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  #signatureCanvas {
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: #fff;
    cursor: crosshair;
    width: 100%;
    height: 150px;
    display: block;
  }

  .documents-container {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }
  .document-upload {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }
  .document-upload label {
    font-size: var(--small);
    font-weight: 300;
    color: var(--text-dark-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  .document-upload input[type="file"] {
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: var(--bg-dark-card);
    color: var(--muted);
    font-size: 0.75rem;
    font-weight: 300;
    cursor: pointer;
    transition: all 0.3s;
  }
  .document-upload input[type="file"]:hover {
    border-color: var(--accent-light);
  }
  .document-upload input[type="file"]::file-selector-button {
    padding: 0.375rem 1rem;
    margin-right: 1rem;
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: var(--bg-dark-main);
    color: var(--text-dark-primary);
    font-size: 0.75rem;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s;
  }
  .document-upload input[type="file"]::file-selector-button:hover {
    background: var(--accent-light);
    color: var(--text-white);
    border-color: var(--accent-light);
  }
  .upload-status {
    font-size: 0.75rem;
    font-weight: 300;
    letter-spacing: 0.05em;
  }

  .questionnaire-container {
    width: 100%;
    max-width: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }
  .questionnaire-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    align-items: stretch;
    width: 100%;
  }

  .question-progress {
    margin-bottom: 1rem;
  }
  .progress-info {
    display: flex;
    justify-content: center;
    margin-bottom: 0.5rem;
    color: var(--muted);
    font-size: 0.9rem;
  }
  .progress-track {
    height: 6px;
    background: rgba(255, 255, 255, 0.04);
    border-radius: 999px;
    overflow: hidden;
  }
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-light), var(--accent));
    width: 0;
    transition: width 250ms ease;
  }

  .question-actions {
    margin-bottom: 0.75rem;
    display: flex;
    gap: 0.75rem;
  }
  .char-counter {
    font-size: 0.75rem;
    color: var(--muted);
    text-align: right;
  }
  .question-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    width: 100%;
    max-width: 100%;
    padding: 0 1rem;
  }
  .question-field label {
    font-size: var(--small);
    font-weight: 300;
    color: var(--text-dark-primary);
    text-transform: uppercase;
    letter-spacing: 0.1em;
  }
  .question-field textarea {
    min-height: 100px;
    max-height: 400px;
    padding: 0.75rem 1rem;
    border: 1px solid var(--border-dark);
    border-radius: 2px;
    background: var(--bg-dark-card);
    color: var(--text-dark-primary);
    font-family: inherit;
    font-size: 0.875rem;
    font-weight: 300;
    line-height: 1.6;
    resize: vertical;
    transition: all 0.3s;
    width: 100%;
    box-sizing: border-box;
  }
  .question-field textarea:focus {
    outline: none;
    border-color: var(--accent-light);
    background: var(--bg-dark-main);
  }
  .question-field textarea::placeholder {
    color: var(--muted);
    opacity: 0.5;
  }
  .field-error {
    outline: 2px solid rgba(239, 68, 68, 0.18);
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.04) inset;
  }

  .success-message {
    text-align: center;
    padding: 2rem 0;
  }
  .success-icon {
    font-size: 4rem;
    font-weight: 200;
    color: var(--accent-light);
    margin-bottom: 1.5rem;
    line-height: 1;
  }
  .success-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--muted);
    font-weight: 300;
    margin: 0;
  }

  .calendar-section {
    margin-top: 2rem;
  }
  .calendar-text {
    font-size: 0.875rem;
    font-weight: 300;
    color: var(--text-dark-primary);
    text-align: center;
    margin: 1rem 0 1.5rem 0;
    letter-spacing: 0.05em;
  }
  .error-text {
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--muted);
    text-align: center;
    font-weight: 300;
  }
  .btn-primary,
  .btn-secondary {
    width: 100%;
    text-align: center;
  }

  @media (max-width: 640px) {
    .welcome-container {
      padding: 1.5rem 1rem;
    }
    .step-wrapper {
      max-width: 100%;
      padding: 0 0.5rem;
    }
    .question-field {
      max-width: 100% !important;
      padding: 0 !important;
    }
    .question-field textarea {
      width: 100% !important;
    }
    .firm-logo img,
    .firm-logo-img {
      width: 16px;
      height: 8px;
      max-width: 16px;
      max-height: 8px;
    }
    .contract-viewer iframe {
      width: 100% !important;
      height: 300px;
    }
    #signatureCanvas {
      height: 120px;
    }
    .form-header h1 {
      font-size: 1.5rem;
    }
  }

  @media (min-width: 640px) {
    .welcome-container {
      padding: 3rem 2rem;
    }
  }
  @media (min-width: 768px) {
    .step-wrapper {
      padding: 0 1rem;
    }
  }
</style>

<script define:vars={{ token }}>
  // Compact, modular portal script: unifica canvas, documentos, cuestionario y navegación de pasos.
  let portalData = null,
    canvas,
    ctx,
    isDrawing = false,
    currentQuestionIndex = 0,
    questionsCount = 0;

  const qs = (sel, root = document) => root.querySelector(sel);
  const qsa = (sel, root = document) => Array.from(root.querySelectorAll(sel));
  const setDisplay = (id, v) => {
    const el = qs("#" + id);
    if (el) el.style.display = v;
  };

  const Portal = {
    init() {
      this.loadPortalData();
    },

    async loadPortalData() {
      try {
        const res = await fetch(`/api/portal/validate?token=${token}`);
        if (!res.ok) return this.showError();
        portalData = await res.json();
        this.initializePortal();
      } catch (e) {
        this.showError();
      }
    },

    initializePortal() {
      setDisplay("loading", "none");

      // Firm logo
      if (portalData?.profile?.firm_logo_url) {
        qs("#firmLogo").innerHTML =
          `<img src="${portalData.profile.firm_logo_url}" alt="Logo" class="firm-logo-img" width="100" height="100"/>`;
      }

      // Contract open button
      const openBtn = qs("#openDocumentBtn");
      if (openBtn) {
        if (portalData?.contract_template?.file_url) {
          openBtn.href = portalData.contract_template.file_url;
          openBtn.style.display = "inline-block";
        } else openBtn.style.display = "none";
      }

      qs("#firmName").textContent =
        portalData?.profile?.firm_name || "ようこそ";
      const clientNameEl = qs("#clientName");
      if (portalData?.client?.client_name) {
        clientNameEl.textContent = portalData.client.client_name;
        clientNameEl.style.display = "block";
      } else clientNameEl.style.display = "none";

      setDisplay("step1", "flex");
      this.setupSignatureCanvas();
    },

    setupSignatureCanvas() {
      canvas = qs("#signatureCanvas");
      if (!canvas) return;

      // Replace node to remove leftover listeners, then compute size and attach pointer events
      const rect = canvas.getBoundingClientRect();
      const newCanvas = canvas.cloneNode(true);
      canvas.parentNode.replaceChild(newCanvas, canvas);
      canvas = newCanvas;
      ctx = canvas.getContext("2d");
      canvas.width = Math.max(rect.width, 300);
      canvas.height = 150;
      ctx.strokeStyle = "#000";
      ctx.lineWidth = 2;
      ctx.lineCap = "round";

      canvas.addEventListener("pointerdown", (e) => {
        isDrawing = true;
        canvas.setPointerCapture(e.pointerId);
        const r = canvas.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
      });
      canvas.addEventListener("pointermove", (e) => {
        if (!isDrawing) return;
        const r = canvas.getBoundingClientRect();
        ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
        ctx.stroke();
        qs("#signBtn").disabled = false;
      });
      const end = (e) => {
        isDrawing = false;
        try {
          canvas.releasePointerCapture &&
            canvas.releasePointerCapture(e?.pointerId);
        } catch (e) {}
      };
      canvas.addEventListener("pointerup", end);
      canvas.addEventListener("pointercancel", end);
      canvas.addEventListener("pointerout", end);
    },

    clearSignature() {
      if (ctx && canvas) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        qs("#signBtn").disabled = true;
      }
    },

    async signContract() {
      if (!canvas) return alert("Firma no disponible");
      const signatureData = canvas.toDataURL();
      try {
        const res = await fetch("/api/portal/sign", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token,
            signature_data: signatureData,
            ip_address: "client-ip",
          }),
        });
        if (res.ok) this.nextStep(3);
        else alert("Error al firmar el contrato");
      } catch (e) {
        alert("Error al firmar el contrato");
      }
    },

    nextStep(step) {
      qsa(".step").forEach((s) => (s.style.display = "none"));
      setDisplay(`step${step}`, "flex");
      if (step === 2) setTimeout(() => this.setupSignatureCanvas(), 100);
      if (step === 3) this.renderDocuments();
      if (step === 4) this.loadQuestionnaire();
    },

    renderDocuments() {
      const container = qs("#documentsContainer");
      if (!container) return;
      container.innerHTML = "";
      const docs = portalData?.client?.required_documents || [];
      docs.forEach((docType) => {
        const div = document.createElement("div");
        div.className = "document-upload";
        div.innerHTML = `<label>${docType.replace("_", " ").toUpperCase()}</label><input type="file" data-doctype="${docType}" class="doc-input" accept="image/*,application/pdf" /><span class="upload-status"></span>`;
        container.appendChild(div);
      });

      // Delegated handler
      qsa(".doc-input").forEach((input) =>
        input.addEventListener("change", async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;
          const docType = e.target.dataset.doctype;
          const status = e.target.parentElement.querySelector(".upload-status");
          status.textContent = "Subiendo...";
          const fd = new FormData();
          fd.append("token", token);
          fd.append("document_type", docType);
          fd.append("file", file);
          try {
            const r = await fetch("/api/portal/upload-document", {
              method: "POST",
              body: fd,
            });
            if (r.ok) {
              status.textContent = "✓ Subido";
              status.style.color = "#22c55e";
            } else {
              status.textContent = "✗ Error";
              status.style.color = "#ef4444";
            }
          } catch (err) {
            status.textContent = "✗ Error";
            status.style.color = "#ef4444";
          }
        })
      );
    },

    loadQuestionnaire() {
      const form = qs("#questionnaireForm");
      const progressWrap = qs("#questionProgress");
      if (!form) return;
      form.innerHTML = "";
      const questions = (portalData?.questionnaire?.questions || [])
        .slice()
        .sort((a, b) => (a.order_index || 0) - (b.order_index || 0));
      if (!questions.length) {
        form.innerHTML =
          '<p class="error-text">No hay preguntas disponibles.</p>';
        if (progressWrap) progressWrap.style.display = "none";
        return;
      }

      questions.forEach((q, idx) => {
        const maxLen = q.max_length || 1000;
        const required = q.required ? "required" : "";
        const div = document.createElement("div");
        div.className = "question-field";
        div.dataset.idx = idx;
        div.style.display = "none";
        div.innerHTML = `<label>${idx + 1}. ${q.question_text}${q.required ? " *" : ""}</label><textarea data-qid="${q.id}" data-idx="${idx}" maxlength="${maxLen}" placeholder="Escribe tu respuesta..." ${required}></textarea><div class="char-counter" data-qid="${q.id}">0/${maxLen}</div>`;
        form.appendChild(div);
      });

      if (progressWrap) progressWrap.style.display = "block";

      qsa("#questionnaireForm textarea").forEach((ta) => {
        this.autosizeTextarea(ta);
        this.updateCharCounter(ta);
        ta.addEventListener("input", () => {
          this.autosizeTextarea(ta);
          this.updateCharCounter(ta);
          this.saveDraft();
          this.updateProgress();
        });
      });

      this.loadDraft();
      questionsCount = questions.length;
      currentQuestionIndex = 0;
      this.showQuestion(0);
    },

    autosizeTextarea(el) {
      if (!el) return;
      el.style.height = "auto";
      el.style.height = Math.min(el.scrollHeight, 400) + "px";
    },
    updateCharCounter(el) {
      const qid = el.dataset.qid;
      const counter = qs(`.char-counter[data-qid="${qid}"]`);
      const max = el.getAttribute("maxlength") || 1000;
      if (counter) counter.textContent = `${el.value.length}/${max}`;
    },

    saveDraft() {
      try {
        const answers = {};
        qsa("#questionnaireForm textarea").forEach(
          (ta) => (answers[ta.dataset.qid] = ta.value)
        );
        localStorage.setItem(
          `portal_answers_${token}`,
          JSON.stringify(answers)
        );
      } catch (e) {}
    },
    loadDraft() {
      try {
        const raw = localStorage.getItem(`portal_answers_${token}`);
        if (!raw) return;
        const answers = JSON.parse(raw);
        Object.keys(answers).forEach((qid) => {
          const ta = qs(`#questionnaireForm textarea[data-qid="${qid}"]`);
          if (ta) {
            ta.value = answers[qid] || "";
            this.autosizeTextarea(ta);
            this.updateCharCounter(ta);
          }
        });
      } catch (e) {}
    },

    updateProgress() {
      const total =
        questionsCount || qsa("#questionnaireForm .question-field").length;
      if (!total) return;
      const idx = currentQuestionIndex || 0;
      const pct = Math.round(((idx + 1) / total) * 100);
      const bar = qs("#progressBar");
      const txt = qs("#progressText");
      if (bar) bar.style.width = pct + "%";
      if (txt) txt.textContent = `Pregunta ${idx + 1} de ${total}`;
    },

    showFieldError(el) {
      el && el.classList.add("field-error");
    },
    clearFieldError(el) {
      el && el.classList.remove("field-error");
    },

    showQuestion(idx) {
      const fields = qsa("#questionnaireForm .question-field");
      const total = fields.length;
      if (!total) return;
      if (idx < 0) idx = 0;
      if (idx > total - 1) idx = total - 1;
      currentQuestionIndex = idx;
      fields.forEach((f) => (f.style.display = "none"));
      const cur = qs(`#questionnaireForm .question-field[data-idx="${idx}"]`);
      if (cur) cur.style.display = "block";
      const prevBtn = qs("#prevQuestionBtn");
      const nextBtn = qs("#nextQuestionBtn");
      if (prevBtn) prevBtn.disabled = idx === 0;
      if (nextBtn)
        nextBtn.textContent =
          idx === total - 1 ? "Enviar Respuestas" : "Siguiente";
      this.updateProgress();
    },

    nextQuestion() {
      const total = qsa("#questionnaireForm .question-field").length;
      if (!total) return;
      const curTa = qs(
        `#questionnaireForm .question-field[data-idx="${currentQuestionIndex}"] textarea`
      );
      if (curTa) {
        this.clearFieldError(curTa);
        if (curTa.hasAttribute("required") && curTa.value.trim() === "") {
          this.showFieldError(curTa);
          curTa.scrollIntoView({ behavior: "smooth", block: "center" });
          return alert("Por favor, responde la pregunta antes de continuar.");
        }
      }
      if (currentQuestionIndex >= total - 1) return this.submitQuestionnaire();
      currentQuestionIndex += 1;
      this.showQuestion(currentQuestionIndex);
    },

    prevQuestion() {
      if (currentQuestionIndex <= 0) return;
      currentQuestionIndex -= 1;
      this.showQuestion(currentQuestionIndex);
    },

    async submitQuestionnaire() {
      const submitBtn = qs("#submitAnswersBtn");
      const textareas = qsa("#questionnaireForm textarea");
      let firstInvalid = null;
      textareas.forEach((ta) => this.clearFieldError(ta));
      for (const ta of textareas) {
        if (ta.hasAttribute("required") && ta.value.trim() === "") {
          this.showFieldError(ta);
          if (!firstInvalid) firstInvalid = ta;
        }
      }
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: "smooth", block: "center" });
        return alert(
          "Por favor, responde las preguntas marcadas con * antes de continuar."
        );
      }
      const answers = textareas.map((ta) => ({
        question_id: ta.dataset.qid,
        answer_text: ta.value,
      }));
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = "Enviando...";
      }
      try {
        const r = await fetch("/api/portal/submit-answers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, answers }),
        });
        if (r.ok) {
          try {
            localStorage.removeItem(`portal_answers_${token}`);
          } catch (e) {}
          await this.completeProcess();
        } else alert("Error al enviar respuestas");
      } catch (e) {
        alert("Error al enviar respuestas");
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = "Enviar Respuestas";
        }
      }
    },

    async completeProcess() {
      try {
        await fetch("/api/portal/complete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token }),
        });
        if (portalData?.profile?.calendar_link) {
          setDisplay("calendarSection", "block");
          qs("#calendarLink").href = portalData.profile.calendar_link;
        }
        this.nextStep(5);
      } catch (e) {
        alert("Error al completar el proceso");
      }
    },

    showError() {
      setDisplay("loading", "none");
      setDisplay("errorScreen", "block");
    },
  };

  // Expose required functions for inline onclick attributes
  window.clearSignature = () => Portal.clearSignature();
  window.nextStep = (n) => Portal.nextStep(n);
  window.nextQuestion = () => Portal.nextQuestion();
  window.prevQuestion = () => Portal.prevQuestion();
  window.signContract = () => Portal.signContract();
  window.submitQuestionnaire = () => Portal.submitQuestionnaire();

  // Init
  Portal.init();
</script>
